version: 2.1

orbs:
  docker: circleci/docker@1.5.0

jobs:
  lint:
      executor: docker/machine
      steps:
        - checkout
        - run: ls web
        - docker/dockerlint:
            dockerfile: web/Dockerfile
            #treat-warnings-as-errors: true

  check_docker_image_building:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - checkout
      - run:
          name: Build nginx image
          command: docker build -t nginx:check ./web
     
  check_docker_compose_up_command:
     machine:
      image: ubuntu-2004:202101-01
     steps:
      - checkout
      - run:
          name: Run docker-compose up command
          command: |
             docker-compose up -d
             cat /etc/hosts
             sleep 60
             docker-compose logs > /tmp/log.txt
             sudo cat "127.0.0.1 cloud.example.com" >> /etc/hosts
             curl --cacert ./web/certs/domain.crt -I  https://cloud.example.com:8080 | grep '200 OK' 
      - store_artifacts:
           path: /tmp/log.txt
workflows:
  check_container_environment:
    jobs:
      - lint:
          filters:
            branches:
              only: /.*/
      - check_docker_image_building:
          requires:
            - lint
      - check_docker_compose_up_command:
          requires:
             - check_docker_image_building
